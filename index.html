<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Caf√© Portal ‚Äî Men√∫ Interactivo</title>

  <style>
    :root{
      --bg:#050712;
      --text:#eaf0ff;
      --line:#1a2550;
      --accent:#39b8ff;
      --accent2:#7c4dff;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:18px;

      --brand-size: clamp(20px, 4.8vw, 28px);
      --brand-letter: clamp(2.2px, 0.7vw, 3.6px);

      /* Portal global (modal) */
      --portal: rgba(57,184,255,.95);
      --portal2: rgba(124,77,255,.75);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      color:var(--text);
      min-height:100vh;
      padding-bottom: 84px;
      background: var(--bg);
      overflow-x:hidden;
    }

    #stars{
      position:fixed; inset:0;
      z-index:-3;
      width:100%;
      height:100%;
      display:block;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(57,184,255,.16), transparent 55%),
                  radial-gradient(900px 600px at 80% 20%, rgba(124,77,255,.16), transparent 60%),
                  radial-gradient(800px 700px at 55% 90%, rgba(44,246,196,.08), transparent 60%),
                  var(--bg);
    }
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      z-index:-2;
      background: radial-gradient(circle at 50% 30%, rgba(0,0,0,.0), rgba(0,0,0,.55) 70%, rgba(0,0,0,.75) 100%);
    }

    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(5,7,18,.92), rgba(5,7,18,.55));
      border-bottom:1px solid rgba(26,37,80,.6);
    }

    .wrap{max-width:1150px; margin:0 auto; padding:18px 16px}
    .top{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; align-items:center; gap:12px; user-select:none;}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(57,184,255,.9), rgba(124,77,255,.7) 45%, rgba(44,246,196,.35) 75%, rgba(0,0,0,.0) 76%),
                  linear-gradient(135deg, rgba(57,184,255,.35), rgba(124,77,255,.15));
      border:1px solid rgba(57,184,255,.35);
      box-shadow: 0 0 0 1px rgba(124,77,255,.25) inset, 0 0 26px rgba(57,184,255,.25);
      position:relative; overflow:hidden;
      flex: 0 0 auto;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 0deg, rgba(57,184,255,.0), rgba(57,184,255,.35), rgba(124,77,255,.35), rgba(44,246,196,.25), rgba(57,184,255,.0));
      animation: spin 7s linear infinite;
      filter: blur(1px);
      opacity:.85;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .brandTitle{
      margin:0;
      font-size: var(--brand-size);
      letter-spacing: var(--brand-letter);
      text-transform:uppercase;
      text-shadow:0 0 18px rgba(57,184,255,.45),0 0 42px rgba(57,184,255,.20);
      font-weight:1000;
      line-height:1.05;
      white-space:nowrap;
    }
    @media (max-width: 360px){ .brandTitle{ white-space:normal; } }

    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; flex:1;}
    .search{
      flex:1; min-width:230px;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      background: rgba(11,16,36,.75);
      border:1px solid rgba(26,37,80,.7);
      border-radius:14px;
      box-shadow: 0 0 0 1px rgba(57,184,255,.08) inset;
    }
    .search input{width:100%; background:transparent; border:0; outline:0; color:var(--text); font-size:14px;}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(26,37,80,.8);
      background: rgba(11,16,36,.65);
      color:rgba(234,240,255,.9);
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, border-color .15s ease, background .15s ease;
      text-transform:uppercase;
      letter-spacing:1.4px;
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
    }
    .pill:hover{transform:translateY(-1px); border-color: rgba(57,184,255,.55)}
    .pill.active{
      border-color: rgba(57,184,255,.75);
      background: linear-gradient(135deg, rgba(57,184,255,.18), rgba(124,77,255,.14));
      box-shadow: 0 0 0 1px rgba(57,184,255,.14) inset, 0 0 24px rgba(57,184,255,.12);
    }

    .heroTitle{
      font-size:24px;
      font-weight:1000;
      letter-spacing:3.2px;
      text-transform:uppercase;
      margin:0 0 12px;
      text-align:center;
      color: rgba(234,240,255,.92);
      text-shadow: 0 0 18px rgba(57,184,255,.35), 0 0 36px rgba(57,184,255,.18);
    }
    .heroLine{
      height:2px; margin:0 auto 12px; width:min(720px, 100%);
      background: linear-gradient(90deg, rgba(57,184,255,0), rgba(57,184,255,.75), rgba(124,77,255,.65), rgba(57,184,255,.75), rgba(57,184,255,0));
      box-shadow: 0 0 18px rgba(57,184,255,.16);
    }

    .grid{
      display:grid;
      grid-template-columns: 290px 1fr 330px;
      gap:16px;
      margin-top:16px;
      align-items:start;
    }
    @media (max-width: 1050px){ .grid{grid-template-columns: 1fr; } }

    .panel{
      background: rgba(11,16,36,.58);
      border:1px solid rgba(26,37,80,.7);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      overflow:hidden;
      position:relative;
    }
    .panel:before{
      content:"";
      position:absolute;
      left:14px; right:14px; top:52px;
      height:2px;
      background: linear-gradient(90deg, rgba(57,184,255,0), rgba(57,184,255,.65), rgba(124,77,255,.55), rgba(57,184,255,.65), rgba(57,184,255,0));
      opacity:.9;
      pointer-events:none;
    }
    .panel h2{
      font-size:13px;
      text-transform:uppercase;
      color:rgba(234,240,255,.78);
      margin:0;
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(26,37,80,.45);
      background: linear-gradient(to bottom, rgba(11,16,36,.85), rgba(11,16,36,.25));
      text-shadow: 0 0 14px rgba(57,184,255,.22);
      letter-spacing:1.4px;
      font-weight:900;
    }

    .cats{padding:10px}
    .catbtn{
      width:100%;
      text-align:left;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid transparent;
      background: transparent;
      color:rgba(234,240,255,.9);
      cursor:pointer;
      display:flex; justify-content:space-between; align-items:center;
      text-transform:uppercase;
      letter-spacing:1.2px;
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
    }
    .catbtn:hover{background: rgba(57,184,255,.08)}
    .catbtn.active{
      background: linear-gradient(135deg, rgba(57,184,255,.14), rgba(124,77,255,.10));
      border-color: rgba(57,184,255,.35);
      box-shadow: 0 0 22px rgba(57,184,255,.10);
    }
    .badge{
      font-size:12px; color:rgba(234,240,255,.7);
      border:1px solid rgba(26,37,80,.7);
      padding:3px 8px; border-radius:999px;
      background: rgba(5,7,18,.35);
      letter-spacing:.4px;
      text-transform:none;
      font-weight:900;
    }

    .content{padding:14px}
    .sectiontitle{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px; flex-wrap:wrap;
    }
    .sectiontitle h3{margin:0; font-size:16px; text-transform:uppercase; letter-spacing:1.6px; text-shadow: 0 0 16px rgba(57,184,255,.22); font-weight:1000;}
    .hint{font-size:12px; color:rgba(234,240,255,.65)}
    .subtabs{display:flex; gap:8px; flex-wrap:wrap;}

    .cards{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
      content-visibility: auto;
      contain-intrinsic-size: 1px 500px;
    }
    @media (max-width: 1040px){ .cards{grid-template-columns: repeat(2, minmax(0,1fr));} }
    @media (max-width: 560px){ .cards{grid-template-columns:1fr;} }

    .item{
      background: rgba(5,7,18,.35);
      border:1px solid rgba(26,37,80,.75);
      border-radius: 18px;
      padding:12px;
      transition: transform .10s ease, border-color .15s ease, background .15s ease;
      position:relative;
      overflow:hidden;
      -webkit-tap-highlight-color: transparent;
      contain: layout paint;
    }
    .item:hover{
      transform: translateY(-2px);
      border-color: rgba(57,184,255,.55);
      background: rgba(5,7,18,.55);
    }

    /* ‚úÖ Portal click sobre card */
    .item .tapPortal{
      position:absolute;
      left: var(--rx, 50%);
      top: var(--ry, 45%);
      width: 14px;
      height: 14px;
      transform: translate(-50%,-50%) scale(0.25);
      border-radius: 999px;
      opacity:0;
      pointer-events:none;
      z-index:0;
      filter:
        drop-shadow(0 0 10px var(--pc1, rgba(57,184,255,.95)))
        drop-shadow(0 0 24px var(--pc1, rgba(57,184,255,.95)))
        drop-shadow(0 0 52px var(--pc2, rgba(124,77,255,.75)));
      background:
        radial-gradient(circle at 50% 50%,
          rgba(255,255,255,.70),
          var(--pc1, rgba(57,184,255,.95)) 35%,
          rgba(0,0,0,0) 70%);
    }
    .item.tap .tapPortal{ animation: tapPortalBurst .62s ease-out forwards; }
    @keyframes tapPortalBurst{
      0%   { opacity:0; transform: translate(-50%,-50%) scale(0.25); }
      18%  { opacity:1; }
      55%  { opacity:.95; transform: translate(-50%,-50%) scale(16); }
      100% { opacity:0; transform: translate(-50%,-50%) scale(22); }
    }
    .item .tapPortal:after{
      content:"";
      position:absolute; inset:-22%;
      border-radius:999px;
      border: 2px solid var(--pc1, rgba(57,184,255,.95));
      opacity:0;
      filter: blur(.2px);
    }
    .item.tap .tapPortal:after{ animation: tapRing .62s ease-out forwards; }
    @keyframes tapRing{
      0%{ opacity:0; transform: scale(.55) rotate(0deg); }
      20%{ opacity:.95; }
      100%{ opacity:0; transform: scale(1.35) rotate(140deg); }
    }

    .item .tapHalo{
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 50% 50%, var(--pc2, rgba(124,77,255,.75)), rgba(0,0,0,0) 60%);
      opacity:0;
      filter: blur(22px);
      pointer-events:none;
      z-index:0;
      transform: scale(.9);
    }
    .item.tap .tapHalo{ animation: halo .62s ease-out forwards; }
    @keyframes halo{
      0%{ opacity:0; transform: scale(.85); }
      30%{ opacity:.35; }
      100%{ opacity:0; transform: scale(1.08); }
    }

    .item.tap{ animation: cardPulse .35s ease-out both; }
    @keyframes cardPulse{
      0%{ transform: translateY(0) scale(1); box-shadow: none; }
      35%{
        transform: translateY(-2px) scale(1.01);
        box-shadow: 0 0 0 1px rgba(57,184,255,.22) inset, 0 0 36px rgba(57,184,255,.10);
      }
      100%{ transform: translateY(0) scale(1); box-shadow: none; }
    }

    .tagrow{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; position:relative; z-index:1;}
    .tag{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(26,37,80,.7);
      background: rgba(11,16,36,.55);
      color: rgba(234,240,255,.78);
      text-transform:uppercase;
      letter-spacing:1px;
      font-weight:900;
    }
    .tag.hot{border-color: rgba(255,80,80,.55); color: rgba(255,120,120,.98)}
    .tag.cold{border-color: rgba(57,184,255,.55); color: rgba(57,184,255,.95)}
    .tag.frappe{border-color: rgba(160,110,255,.55); color: rgba(196,164,255,.98)}
    .tag.special{border-color: rgba(44,246,196,.45); color: rgba(44,246,196,.95)}
    .tag.baseCafe{border-color: rgba(57,184,255,.55); color: rgba(57,184,255,.95)}
    .tag.baseRef{border-color: rgba(44,246,196,.45); color: rgba(44,246,196,.95)}
    .tag.baseSnack{border-color: rgba(255,214,140,.40); color: rgba(255,214,140,.95)}

    .name{font-weight:1000; margin:0 0 6px; font-size:15px; text-transform:uppercase; letter-spacing:1.3px; position:relative; z-index:1;}
    .desc{margin:0 0 10px; font-size:12px; color:rgba(234,240,255,.68); line-height:1.35; position:relative; z-index:1;}

    .prices{display:flex; gap:8px; flex-wrap:wrap; align-items:center; position:relative; z-index:1;}
    .pricebtn{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(26,37,80,.8);
      background: rgba(11,16,36,.7);
      color: rgba(234,240,255,.92);
      cursor:pointer;
      font-size:13px;
      display:inline-flex; align-items:center; gap:8px;
      text-transform:uppercase;
      letter-spacing:1px;
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
      position:relative;
      overflow:hidden;
    }
    .pricebtn:hover{border-color: rgba(57,184,255,.55)}
    .pricebtn small{opacity:.7; font-weight:900}
    .pricebtn.tapBtn{ animation: btnPulse .28s ease-out both; }
    @keyframes btnPulse{
      0%{ transform: scale(1); box-shadow: none; }
      40%{ transform: scale(1.02); box-shadow: 0 0 0 1px rgba(57,184,255,.35) inset, 0 0 22px rgba(57,184,255,.18); }
      100%{ transform: scale(1); box-shadow: none; }
    }

    .cart{position:sticky; top:92px}
    .cartbox{padding:12px}
    .cartlist{display:flex; flex-direction:column; gap:8px; margin:10px 0 12px}
    .lineitem{
      display:flex; gap:10px; justify-content:space-between; align-items:flex-start;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(26,37,80,.7);
      background: rgba(5,7,18,.35);
    }
    .li-title{font-size:13px; font-weight:1000; margin:0; text-transform:uppercase; letter-spacing:1.2px;}
    .li-sub{font-size:12px; color:rgba(234,240,255,.65); margin-top:2px}
    .li-actions{display:flex; gap:8px; align-items:center}
    .mini{
      width:30px; height:30px; border-radius:10px;
      border:1px solid rgba(26,37,80,.8);
      background: rgba(11,16,36,.7);
      color: rgba(234,240,255,.92);
      cursor:pointer;
      display:grid; place-items:center;
      font-weight:1000;
      -webkit-tap-highlight-color: transparent;
    }
    .mini:hover{border-color: rgba(57,184,255,.55)}
    .qty{min-width:18px; text-align:center; font-weight:1000}

    .totals{
      display:flex; justify-content:space-between; align-items:center;
      padding-top:10px;
      border-top:1px solid rgba(26,37,80,.65);
      color: rgba(234,240,255,.9);
      text-transform:uppercase;
      letter-spacing:1.1px;
      font-weight:900;
    }
    .checkout{
      margin-top:10px;
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(57,184,255,.6);
      background: linear-gradient(135deg, rgba(57,184,255,.22), rgba(124,77,255,.18));
      color: rgba(234,240,255,.95);
      font-weight:1000;
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:1.6px;
      -webkit-tap-highlight-color: transparent;
    }
    .danger{
      margin-top:10px;
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,120,120,.45);
      background: rgba(255,120,120,.08);
      color: rgba(234,240,255,.92);
      font-weight:1000;
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:1.2px;
      -webkit-tap-highlight-color: transparent;
    }

    .btn[disabled], .checkout[disabled]{ opacity:.55; cursor:not-allowed; filter: grayscale(20%); }

    #waFloat{
      position: fixed;
      left: 50%;
      bottom: calc(14px + env(safe-area-inset-bottom, 0px));
      z-index: 9999;

      width: min(560px, calc(100vw - 28px));
      padding: 14px 14px;
      border-radius: 18px;

      border: 1px solid rgba(57,184,255,.65);
      background: linear-gradient(135deg, rgba(57,184,255,.26), rgba(124,77,255,.18));
      color: rgba(234,240,255,.98);

      font-weight: 1000;
      cursor: pointer;

      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;

      box-shadow: 0 18px 60px rgba(0,0,0,.50);
      text-transform:uppercase;
      letter-spacing:1.6px;

      opacity: 0;
      pointer-events: none;
      transform: translateX(-50%) translateY(10px);
      transition: opacity .18s ease, transform .18s ease;
      -webkit-tap-highlight-color: transparent;
    }
    #waFloat .left{display:flex; align-items:center; gap:10px;}
    #waFloat .wabadge{
      background: rgba(5,7,18,.55);
      border: 1px solid rgba(26,37,80,.8);
      color: rgba(234,240,255,.9);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      text-transform: none;
      letter-spacing: .4px;
      opacity:.95;
      white-space:nowrap;
      font-weight:900;
    }

    .cartTabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .cartTabBtn{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(26,37,80,.8);
      background: rgba(11,16,36,.65);
      color: rgba(234,240,255,.9);
      cursor:pointer;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:1.2px;
      font-weight:1000;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .cartTabBtn:hover{transform:translateY(-1px); border-color: rgba(57,184,255,.55)}
    .cartTabBtn.active{
      border-color: rgba(57,184,255,.75);
      background: linear-gradient(135deg, rgba(57,184,255,.18), rgba(124,77,255,.14));
      box-shadow: 0 0 0 1px rgba(57,184,255,.14) inset, 0 0 24px rgba(57,184,255,.10);
    }
    .cartView{display:block}
    .nameView{display:none}
    .input{
      width:100%;
      margin-top:6px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(26,37,80,.75);
      background: rgba(5,7,18,.45);
      color: rgba(234,240,255,.92);
      outline:none;
    }

    /* ============================
       Modal + Portal (fondo)
       ============================ */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.20);
      display:none;
      z-index: 10000;
      padding: 18px;
    }
    .modalOverlay.open{display:flex; align-items:center; justify-content:center;}

    #portalFX{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:0;
      transition: opacity .12s ease;
      z-index:0;
    }
    #portalFX.on{ opacity:1; }

    .portalWash{
      position:absolute; inset:0;
      background:
        radial-gradient(900px 700px at 50% 45%, rgba(0,0,0,0), rgba(0,0,0,.55) 70%, rgba(0,0,0,.78) 100%),
        radial-gradient(1200px 900px at 50% 45%, var(--portal2), rgba(0,0,0,0) 70%),
        radial-gradient(900px 650px at 50% 45%, var(--portal), rgba(0,0,0,0) 62%);
      opacity:.95;
    }

    .portalWrap{
      position:absolute;
      left:50%; top:48%;
      width: min(560px, 84vw);
      aspect-ratio: 1 / 1;
      transform: translate(-50%,-50%) scale(.92);
      opacity:1;
      filter: drop-shadow(0 0 18px var(--portal))
              drop-shadow(0 0 60px var(--portal))
              drop-shadow(0 0 120px var(--portal2));
      animation: portalIn .24s ease-out both;
    }
    @keyframes portalIn{
      from{ transform: translate(-50%,-50%) scale(.80); opacity:0; }
      to{ transform: translate(-50%,-50%) scale(.92); opacity:1; }
    }

    .portalFlash{
      position:absolute; inset:-12%;
      border-radius:999px;
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,.75), rgba(255,255,255,0) 62%);
      opacity:0;
      filter: blur(12px);
      animation: flash 650ms ease-out both;
    }
    @keyframes flash{
      0%{opacity:0; transform:scale(.86)}
      22%{opacity:.95; transform:scale(1.03)}
      100%{opacity:0; transform:scale(1.18)}
    }

    .portalCore{
      position:absolute; inset: 22%;
      border-radius:999px;
      background:
        radial-gradient(circle at 35% 30%,
          rgba(255,255,255,.45),
          var(--portal) 35%,
          rgba(0,0,0,0) 72%);
      opacity:.70;
      filter: blur(10px);
      animation: corePulse 1.0s ease-in-out infinite;
    }
    @keyframes corePulse{
      0%,100%{ transform: scale(1); opacity:.55; }
      50%{ transform: scale(1.10); opacity:.88; }
    }

    .portalRing{
      position:absolute; inset: 7%;
      border-radius:999px;
      background:
        radial-gradient(circle at 50% 50%,
          rgba(0,0,0,0) 50%,
          var(--portal) 60%,
          rgba(0,0,0,0) 74%),
        conic-gradient(from 0deg,
          rgba(255,255,255,0),
          var(--portal),
          rgba(255,255,255,0),
          var(--portal2),
          rgba(255,255,255,0));
      opacity:1;
      filter: blur(1px);
      animation: ringSpin .95s linear infinite;
    }
    @keyframes ringSpin{ to{ transform: rotate(360deg); } }

    .portalWave{
      position:absolute; inset: 8%;
      border-radius:999px;
      border: 3px solid var(--portal);
      opacity:0;
      filter: blur(.6px);
      animation: wave .9s ease-out infinite;
    }
    .portalWave.w2{ animation-delay: .30s; border-color: var(--portal2); }
    .portalWave.w3{ animation-delay: .60s; border-color: var(--portal); }
    @keyframes wave{
      0%{ transform: scale(.82); opacity:0; }
      18%{ opacity:.85; }
      100%{ transform: scale(1.22); opacity:0; }
    }

    .portalSparks{
      position:absolute; inset:0;
      border-radius:999px;
      background:
        radial-gradient(circle at 22% 28%, rgba(255,255,255,.7), rgba(255,255,255,0) 38%),
        radial-gradient(circle at 72% 22%, rgba(255,255,255,.45), rgba(255,255,255,0) 36%),
        radial-gradient(circle at 82% 72%, rgba(255,255,255,.35), rgba(255,255,255,0) 36%),
        radial-gradient(circle at 28% 82%, rgba(255,255,255,.50), rgba(255,255,255,0) 38%);
      opacity:.28;
      filter: blur(14px);
      animation: sparks 1.1s ease-in-out infinite alternate;
    }
    @keyframes sparks{
      from{ transform: translateY(-10px) scale(1); opacity:.22;}
      to{ transform: translateY(10px) scale(1.05); opacity:.34;}
    }

    .modal{
      position:relative;
      z-index:1;
      width: min(560px, 92vw);
      border-radius: 18px;
      border:1px solid rgba(26,37,80,.75);
      background: rgba(11,16,36,.94);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(26,37,80,.65);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .modalTitle{margin:0; font-size:16px; font-weight:1000; text-transform:uppercase; letter-spacing:1.6px}
    .close{
      width:34px; height:34px; border-radius:12px;
      border:1px solid rgba(26,37,80,.8);
      background: rgba(5,7,18,.35);
      color: rgba(234,240,255,.9);
      cursor:pointer;
      display:grid; place-items:center;
      font-weight:1000;
      -webkit-tap-highlight-color: transparent;
    }
    .modalBody{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    label{font-size:12px; color:rgba(234,240,255,.75); text-transform:uppercase; letter-spacing:1.2px; font-weight:900;}
    select, textarea{
      width:100%;
      margin-top:6px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(26,37,80,.75);
      background: rgba(5,7,18,.45);
      color: rgba(234,240,255,.92);
      outline:none;
    }
    textarea{min-height:92px; resize:vertical}
    .modalActions{
      padding:14px;
      border-top:1px solid rgba(26,37,80,.65);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }
    .btn{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(26,37,80,.8);
      background: rgba(5,7,18,.35);
      color: rgba(234,240,255,.92);
      cursor:pointer;
      font-weight:1000;
      text-transform:uppercase;
      letter-spacing:1.2px;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.primary{
      border-color: rgba(57,184,255,.6);
      background: linear-gradient(135deg, rgba(57,184,255,.22), rgba(124,77,255,.18));
    }

    /* ============================
       ‚úÖ Bobok FX global (super ligero)
       ============================ */
    #bobokFX{
      position: fixed;
      left: 0; top: 0;
      width: 56px;
      height: 56px;
      pointer-events:none;
      opacity: 0;
      transform: translate3d(-9999px,-9999px,0) scale(.92);
      z-index: 9998;
      mix-blend-mode: screen;
      filter: drop-shadow(0 0 10px rgba(57,184,255,.22))
              drop-shadow(0 0 18px rgba(124,77,255,.18));
      will-change: transform, opacity;
    }
    #bobokFX svg{ width:100%; height:100%; display:block; opacity:.95; }

    #bobokFX.on{ animation: bobokPeek .62s ease-out both; }
    @keyframes bobokPeek{
      0%   { opacity:0; transform: translate3d(var(--bx), var(--by),0) scale(.90); }
      18%  { opacity:.75; }
      55%  { opacity:.92; transform: translate3d(var(--bx), var(--by),0) scale(1.00); }
      100% { opacity:0; transform: translate3d(var(--bx), calc(var(--by) - 10px),0) scale(1.02); }
    }

    @media (prefers-reduced-motion: reduce){
      .item.tap .tapPortal,
      .item.tap .tapPortal:after,
      .item.tap .tapHalo,
      .portalWrap, .portalRing, .portalCore, .portalSparks, .portalWave, .portalFlash,
      #bobokFX.on{
        animation:none!important;
      }
    }
  </style>
</head>

<body>
  <canvas id="stars" aria-hidden="true"></canvas>

  <header>
    <div class="wrap">
      <div class="top">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div><h1 class="brandTitle">CAF√â PORTAL</h1></div>
        </div>

        <div class="controls">
          <div class="search" role="search">
            <span style="opacity:.8">üîé</span>
            <input id="q" placeholder="Buscar: latte, limonada, dorilocos..." autocomplete="off"/>
          </div>
          <button class="pill active" id="baseAll" type="button">Todo</button>
          <button class="pill" id="baseCafe" type="button">‚òï Cafeter√≠a</button>
          <button class="pill" id="baseRef" type="button">üßä Refresquer√≠a</button>
          <button class="pill" id="baseSnk" type="button">üçø Snacks</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <h2 class="heroTitle" id="heroTitle">PORTAL MEN√ö</h2>
    <div class="heroLine"></div>

    <div class="grid">
      <aside class="panel">
        <h2>Categor√≠as</h2>
        <div class="cats" id="cats"></div>
      </aside>

      <section class="panel">
        <h2>Men√∫</h2>
        <div class="content">
          <div class="sectiontitle">
            <div style="display:flex; gap:10px; align-items:baseline; flex-wrap:wrap;">
              <h3 id="sectionName">Todo</h3>
              <div class="hint" id="resultHint"></div>
            </div>
            <div class="subtabs" id="subtabs"></div>
          </div>

          <div class="cards" id="cards"></div>

          <div class="hint" style="margin-top:12px; line-height:1.4">
            <strong>Sabores (Cafeter√≠a):</strong> vainilla, caramelo, mocca, crema irlandesa, avellana.
          </div>
          <div class="hint" style="margin-top:6px; line-height:1.4">
            <strong>Sabores (Limonada de sabor):</strong> frutos rojos, fresa, mango, pepino.
          </div>
        </div>
      </section>

      <aside class="panel cart" id="cartPanel">
        <h2>Carrito</h2>
        <div class="cartbox">
          <div class="hint">Toca un precio para agregar. Puedes anotar ‚Äúsin az√∫car‚Äù, etc.</div>

          <div class="cartTabs">
            <button class="cartTabBtn active" id="tabOrder" type="button">Pedido</button>
            <button class="cartTabBtn" id="tabName" type="button">Tu nombre</button>
          </div>

          <div class="cartView" id="cartView">
            <div class="cartlist" id="cartlist"></div>

            <div class="totals">
              <div><strong>Total</strong></div>
              <div><strong id="total">$0</strong></div>
            </div>

            <button class="checkout" id="checkout" type="button">Enviar pedido por WhatsApp</button>
            <button class="danger" id="clearCart" type="button">Vaciar carrito</button>
          </div>

          <div class="nameView" id="nameView">
            <div style="margin-top:10px">
              <label>Nombre del cliente</label>
              <input id="customerName" class="input" type="text" placeholder="Ej: Jes√∫s" maxlength="40" />
              <div class="hint" style="margin-top:8px; line-height:1.35">
                Este nombre se enviar√° al inicio del pedido por WhatsApp.
              </div>
            </div>
          </div>

        </div>
      </aside>
    </div>
  </main>

  <div class="modalOverlay" id="modalOverlay">
    <div id="portalFX" aria-hidden="true">
      <div class="portalWash"></div>
      <div class="portalWrap">
        <div class="portalFlash"></div>
        <div class="portalSparks"></div>
        <div class="portalRing"></div>
        <div class="portalWave w1"></div>
        <div class="portalWave w2"></div>
        <div class="portalWave w3"></div>
        <div class="portalCore"></div>
      </div>
    </div>

    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div>
          <p class="modalTitle" id="mTitle">Producto</p>
          <div class="hint" id="mMeta"></div>
        </div>
        <button class="close" id="mClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="row">
          <div style="flex:1; min-width:180px">
            <label>Tama√±o</label>
            <select id="mSize"></select>
          </div>

          <div id="optionWrap" style="flex:1; min-width:180px">
            <label>Opci√≥n</label>
            <select id="mOption"></select>
          </div>
        </div>

        <div id="flavorWrapCafe" style="margin-top:10px; display:none">
          <label>Sabor (Cafeter√≠a)</label>
          <select id="mFlavorCafe"></select>
        </div>

        <div id="flavorWrapLemon" style="margin-top:10px; display:none">
          <label>Sabor (Limonada)</label>
          <select id="mFlavorLemon"></select>
        </div>

        <div style="margin-top:10px">
          <label>Extras (opcional)</label>
          <select id="mExtras"></select>
          <div class="hint" style="margin-top:6px" id="extrasHint">Selecciona un extra si lo deseas.</div>
        </div>

        <div style="margin-top:10px">
          <label>Notas (opcional)</label>
          <textarea id="mNotes" placeholder="Ej: sin az√∫car, hielo extra, etc."></textarea>
        </div>
      </div>
      <div class="modalActions">
        <button class="btn" id="mCancel" type="button">Cancelar</button>
        <button class="btn primary" id="mAdd" type="button">Agregar al carrito</button>
      </div>
    </div>
  </div>

  <button id="waFloat" type="button" title="Ver carrito">
    <span class="left">
      <span style="font-size:18px">üßæ</span>
      <span>Ver carrito</span>
    </span>
    <span class="wabadge" id="waBadge">0 items ‚Ä¢ $0</span>
  </button>

  <!-- =========================================================
       ‚úÖ Bobok sprite (1 sola vez) + FX global (1 solo nodo)
       ========================================================= -->
  <svg aria-hidden="true" focusable="false" style="position:absolute;width:0;height:0;overflow:hidden">
    <defs>
      <filter id="bobokGlowStrong" x="-60%" y="-60%" width="220%" height="220%">
        <feGaussianBlur stdDeviation="5.5" result="b1"/>
        <feColorMatrix in="b1" type="matrix"
          values="1 0 0 0 0
                  0 1 0 0 0
                  0 0 1 0 0
                  0 0 0 0.85 0" result="b2"/>
        <feMerge>
          <feMergeNode in="b2"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>

      <filter id="bobokAura" x="-80%" y="-80%" width="260%" height="260%">
        <feGaussianBlur stdDeviation="18" result="a1"/>
        <feColorMatrix in="a1" type="matrix"
          values="0 0 0 0 0
                  0 0.8 0 0 0
                  0 0 1 0 0
                  0 0 0 0.35 0" result="a2"/>
        <feMerge><feMergeNode in="a2"/></feMerge>
      </filter>

      <filter id="bobokSpark" x="-200%" y="-200%" width="500%" height="500%">
        <feGaussianBlur stdDeviation="1.2" result="s1"/>
        <feMerge>
          <feMergeNode in="s1"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>

      <radialGradient id="bobokMist" cx="50%" cy="52%" r="42%">
        <stop offset="0%" stop-color="#33BFFF" stop-opacity="0.35"/>
        <stop offset="55%" stop-color="#1A7CFF" stop-opacity="0.14"/>
        <stop offset="100%" stop-color="#000000" stop-opacity="0"/>
      </radialGradient>

      <symbol id="bobokMark" viewBox="0 0 512 512">
        <rect width="512" height="512" fill="none"/>
        <circle cx="256" cy="270" r="160" fill="url(#bobokMist)" filter="url(#bobokAura)"/>

        <g opacity="0.9" filter="url(#bobokGlowStrong)">
          <line x1="46" y1="256" x2="150" y2="256" stroke="#EAF6FF" stroke-width="4" stroke-linecap="round" opacity="0.65"/>
          <line x1="362" y1="256" x2="466" y2="256" stroke="#EAF6FF" stroke-width="4" stroke-linecap="round" opacity="0.65"/>
          <line x1="120" y1="256" x2="150" y2="256" stroke="#69D6FF" stroke-width="2" stroke-linecap="round" opacity="0.55"/>
          <line x1="362" y1="256" x2="392" y2="256" stroke="#69D6FF" stroke-width="2" stroke-linecap="round" opacity="0.55"/>
        </g>

        <g filter="url(#bobokGlowStrong)">
          <path d="M256 174 L350 256 L256 338 L162 256 Z"
                fill="none" stroke="#FFFFFF" stroke-width="7"
                stroke-linejoin="round" />
          <circle cx="224" cy="252" r="7" fill="#FFFFFF"/>
          <circle cx="288" cy="252" r="7" fill="#FFFFFF"/>
          <circle cx="208" cy="268" r="3" fill="#BFF1FF" opacity="0.7"/>
          <circle cx="304" cy="268" r="3" fill="#BFF1FF" opacity="0.7"/>
          <path d="M224 258 Q214 305 256 322" fill="none" stroke="#FFFFFF" stroke-width="5.5" stroke-linecap="round"/>
          <path d="M288 258 Q298 305 256 322" fill="none" stroke="#FFFFFF" stroke-width="5.5" stroke-linecap="round"/>
          <path d="M256 338 L256 352" stroke="#BFF1FF" stroke-width="3" stroke-linecap="round" opacity="0.55"/>
        </g>

        <g opacity="0.95" filter="url(#bobokSpark)">
          <circle cx="205" cy="205" r="1.8" fill="#EAF6FF"/>
          <circle cx="238" cy="196" r="1.2" fill="#EAF6FF"/>
          <circle cx="278" cy="202" r="1.5" fill="#EAF6FF"/>
          <circle cx="310" cy="220" r="1.1" fill="#EAF6FF"/>
          <circle cx="184" cy="240" r="1.0" fill="#EAF6FF"/>
          <circle cx="330" cy="240" r="1.0" fill="#EAF6FF"/>
          <circle cx="176" cy="270" r="1.4" fill="#EAF6FF"/>
          <circle cx="336" cy="278" r="1.6" fill="#EAF6FF"/>
          <circle cx="210" cy="312" r="1.0" fill="#EAF6FF"/>
          <circle cx="252" cy="330" r="1.3" fill="#EAF6FF"/>
          <circle cx="292" cy="322" r="1.0" fill="#EAF6FF"/>
          <circle cx="318" cy="306" r="1.2" fill="#EAF6FF"/>
          <circle cx="230" cy="222" r="2.6" fill="#9EEBFF" opacity="0.9"/>
          <circle cx="300" cy="292" r="2.3" fill="#9EEBFF" opacity="0.85"/>
          <circle cx="190" cy="288" r="2.0" fill="#9EEBFF" opacity="0.7"/>
        </g>

        <g opacity="0.22" filter="url(#bobokGlowStrong)">
          <path d="M170 275 C190 250, 210 248, 230 268 C250 288, 275 295, 305 285 C335 275, 350 260, 360 246"
                fill="none" stroke="#6FD9FF" stroke-width="6" stroke-linecap="round"/>
          <path d="M160 242 C190 230, 220 236, 245 252 C270 268, 295 270, 332 255"
                fill="none" stroke="#6FD9FF" stroke-width="5" stroke-linecap="round"/>
        </g>
      </symbol>
    </defs>
  </svg>

  <div id="bobokFX" aria-hidden="true">
    <svg viewBox="0 0 512 512"><use href="#bobokMark"></use></svg>
  </div>

<script>
  const WHATSAPP_NUMBER = "526621448175";

  const $ = (sel)=>document.querySelector(sel);
  const money = (n)=>"$" + Number(n).toFixed(0);

  function norm(s){
    return String(s || "")
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toLowerCase();
  }

  const FLAVORS_CAFE = ["Sin sabor", "Vainilla", "Caramelo", "Mocca", "Crema irlandesa", "Avellana"];
  const FLAVORS_LEMON = ["Frutos rojos", "Fresa", "Mango", "Pepino"];

  const NAME_KEY = "cafePortal_customerName";
  let customerName = (localStorage.getItem(NAME_KEY) || "").trim();

  const LEMON_FLAVOR_ITEM_ID = "r_sp_lim_sab";

  const MENU = [
    { id:"c_hot_ame", baseCat:"Cafeter√≠a", subCat:"Caliente", name:"Americano", desc:"Caf√© caliente.", tags:["hot"], sizes:{ "12 oz":40, "16 oz":50 } },
    { id:"c_hot_cap", baseCat:"Cafeter√≠a", subCat:"Caliente", name:"Capuccino", desc:"Espuma y car√°cter.", tags:["hot"], sizes:{ "12 oz":40, "16 oz":50 } },
    { id:"c_hot_lat", baseCat:"Cafeter√≠a", subCat:"Caliente", name:"Latte", desc:"Cremoso y suave.", tags:["hot"], sizes:{ "12 oz":40, "16 oz":50 } },
    { id:"c_hot_fw",  baseCat:"Cafeter√≠a", subCat:"Caliente", name:"Flat White", desc:"Intenso, balanceado.", tags:["hot"], sizes:{ "12 oz":40, "16 oz":50 } },

    { id:"c_cold_ame", baseCat:"Cafeter√≠a", subCat:"Fr√≠o", name:"Americano (fr√≠o)", desc:"Caf√© fr√≠o.", tags:["cold"], sizes:{ "12 oz":50, "16 oz":60 } },
    { id:"c_cold_lat", baseCat:"Cafeter√≠a", subCat:"Fr√≠o", name:"Latte (fr√≠o)", desc:"Latte helado.", tags:["cold"], sizes:{ "12 oz":50, "16 oz":60 } },
    { id:"c_cold_cap", baseCat:"Cafeter√≠a", subCat:"Fr√≠o", name:"Capuccino (fr√≠o)", desc:"Versi√≥n fr√≠a.", tags:["cold"], sizes:{ "12 oz":50, "16 oz":60 } },

    { id:"c_fra_cafe", baseCat:"Cafeter√≠a", subCat:"Frapp√©", name:"Frappe Caf√©", desc:"Frapp√© base caf√©.", tags:["frappe"], sizes:{ "12 oz":55, "16 oz":65 } },
    { id:"c_fra_moc",  baseCat:"Cafeter√≠a", subCat:"Frapp√©", name:"Frappe Mocca", desc:"Chocolate + caf√©.", tags:["frappe"], sizes:{ "12 oz":55, "16 oz":65 } },
    { id:"c_fra_vai",  baseCat:"Cafeter√≠a", subCat:"Frapp√©", name:"Frappe Vainilla", desc:"Cl√°sico dulce.", tags:["frappe"], sizes:{ "12 oz":55, "16 oz":65 } },
    { id:"c_fra_car",  baseCat:"Cafeter√≠a", subCat:"Frapp√©", name:"Frappe Caramelo", desc:"Caramelo intenso.", tags:["frappe"], sizes:{ "12 oz":55, "16 oz":65 } },
    { id:"c_fra_cho",  baseCat:"Cafeter√≠a", subCat:"Frapp√©", name:"Frappe Chocolate", desc:"Chocolate fr√≠o.", tags:["frappe"], sizes:{ "12 oz":55, "16 oz":65 } },
    { id:"c_fra_chai", baseCat:"Cafeter√≠a", subCat:"Frapp√©", name:"Frappe Chai", desc:"Especiado y suave.", tags:["frappe"], sizes:{ "12 oz":55, "16 oz":65 } },

    { id:"c_sp_cho", baseCat:"Cafeter√≠a", subCat:"Caliente", name:"Chocolate caliente", desc:"Especial cafeter√≠a.", tags:["hot","special"], sizes:{ "12 oz":45, "16 oz":55 } },
    { id:"c_sp_chai", baseCat:"Cafeter√≠a", subCat:"Fr√≠o", name:"Chai (caliente o fr√≠o)", desc:"Especial cafeter√≠a.", tags:["cold","special"], sizes:{ "12 oz":50, "16 oz":60 }, options:["Fr√≠o","Caliente"] },
    { id:"c_sp_lec", baseCat:"Cafeter√≠a", subCat:"Caliente", name:"Caf√© lechero", desc:"Especial cafeter√≠a.", tags:["hot","special"], sizes:{ "12 oz":45, "16 oz":55 } },
    { id:"c_sp_ton", baseCat:"Cafeter√≠a", subCat:"Fr√≠o", name:"Americano t√≥nico", desc:"Especial cafeter√≠a.", tags:["cold","special"], sizes:{ "12 oz":45, "16 oz":55 } },

    { id:"r_cla_lim_nat", baseCat:"Refresquer√≠a", subCat:null, name:"Limonada natural", desc:"Bebida cl√°sica.", tags:["cold"], sizes:{ "20 oz":40, "32 oz":50 } },
    { id:"r_cla_lim_min", baseCat:"Refresquer√≠a", subCat:null, name:"Limonada mineral", desc:"Bebida cl√°sica.", tags:["cold"], sizes:{ "20 oz":40, "32 oz":50 } },
    { id:"r_cla_uvola", baseCat:"Refresquer√≠a", subCat:null, name:"Uvola", desc:"Bebida cl√°sica.", tags:["cold"], sizes:{ "20 oz":40, "32 oz":50 } },
    { id:"r_cla_root", baseCat:"Refresquer√≠a", subCat:null, name:"Root Beer", desc:"Bebida cl√°sica.", tags:["cold"], sizes:{ "20 oz":40, "32 oz":50 } },
    { id:"r_cla_sifon", baseCat:"Refresquer√≠a", subCat:null, name:"Sif√≥n", desc:"Bebida cl√°sica.", tags:["cold"], sizes:{ "20 oz":40, "32 oz":50 } },

    { id:"r_sp_lim_sab", baseCat:"Refresquer√≠a", subCat:null, name:"Limonada (sabores)", desc:"Elige: frutos rojos, fresa, mango o pepino.", tags:["cold","special"], sizes:{ "12 oz":50, "16 oz":60 } },
    { id:"r_sp_limona", baseCat:"Refresquer√≠a", subCat:null, name:"Limonagr√≠a", desc:"Especial refresquer√≠a.", tags:["cold","special"], sizes:{ "12 oz":50, "16 oz":60 } },
    { id:"r_sp_soda", baseCat:"Refresquer√≠a", subCat:null, name:"Soda italiana", desc:"Especial refresquer√≠a.", tags:["cold","special"], sizes:{ "12 oz":50, "16 oz":60 } },

    { id:"s_pepi", baseCat:"Snacks", subCat:null, name:"Pepihuates", desc:"Snack.", tags:[], sizes:{ "√önico":35 } },
    { id:"s_papas", baseCat:"Snacks", subCat:null, name:"Papas preparadas", desc:"Snack.", tags:[], sizes:{ "√önico":45 } },
    { id:"s_tosti", baseCat:"Snacks", subCat:null, name:"Tostilocos", desc:"Snack.", tags:[], sizes:{ "√önico":50 } },
    { id:"s_dori", baseCat:"Snacks", subCat:null, name:"Dorilocos", desc:"Snack.", tags:[], sizes:{ "√önico":50 } },
    { id:"s_pan", baseCat:"Snacks", subCat:null, name:"Pan / Galleta", desc:"Snack.", tags:[], sizes:{ "√önico":30 } },
  ];

  let baseFilter = "all";
  let catFilter = "Todo";
  let subFilter = "all";
  let query = "";
  let cart = [];

  function updateHeroTitle(){
    const el = $("#heroTitle");
    if(baseFilter==="Cafeter√≠a") el.textContent = "PORTAL CAFETER√çA";
    else if(baseFilter==="Refresquer√≠a") el.textContent = "PORTAL REFRESQUER√çA";
    else if(baseFilter==="Snacks") el.textContent = "PORTAL SNACKS";
    else el.textContent = "PORTAL MEN√ö";
  }

  function availableLeftCats(){
    if(baseFilter==="Cafeter√≠a") return ["Todo","Caliente","Fr√≠o","Frapp√©","Especiales"];
    if(baseFilter==="Refresquer√≠a") return ["Todo","Cl√°sicas","Especiales"];
    if(baseFilter==="Snacks") return ["Todo"];
    return ["Todo","Cafeter√≠a","Refresquer√≠a","Snacks"];
  }

  function matches(item){
    const baseOk = (baseFilter==="all") ? true : item.baseCat===baseFilter;

    let leftOk = true;
    if(catFilter!=="Todo"){
      if(baseFilter==="Cafeter√≠a"){
        if(catFilter==="Especiales") leftOk = item.baseCat==="Cafeter√≠a" && (item.tags||[]).includes("special");
        else leftOk = item.baseCat==="Cafeter√≠a" && item.subCat===catFilter;
      } else if(baseFilter==="Refresquer√≠a"){
        if(catFilter==="Especiales") leftOk = item.baseCat==="Refresquer√≠a" && (item.tags||[]).includes("special");
        else if(catFilter==="Cl√°sicas") leftOk = item.baseCat==="Refresquer√≠a" && !(item.tags||[]).includes("special");
        else leftOk = true;
      } else if(baseFilter==="Snacks"){
        leftOk = true;
      } else {
        leftOk = item.baseCat===catFilter;
      }
    }

    let subOk = true;
    if(baseFilter==="Cafeter√≠a"){
      subOk = (subFilter==="all") ? true : item.subCat===subFilter;
    }

    const q = norm(query.trim());
    const qOk = !q ? true : (
      norm(item.name).includes(q) ||
      norm(item.desc||"").includes(q) ||
      norm(item.baseCat||"").includes(q)
    );

    return baseOk && leftOk && subOk && qOk;
  }

  function renderBasePills(){
    const map = {
      all: $("#baseAll"),
      "Cafeter√≠a": $("#baseCafe"),
      "Refresquer√≠a": $("#baseRef"),
      "Snacks": $("#baseSnk"),
    };
    Object.values(map).forEach(b=>b.classList.remove("active"));
    if(baseFilter==="all") map.all.classList.add("active");
    else map[baseFilter].classList.add("active");
  }

  function renderLeftCats(){
    const cats = availableLeftCats();
    const el = $("#cats");
    el.innerHTML = "";
    cats.forEach(c=>{
      const count = MENU.filter(m=>{
        const prev = catFilter;
        catFilter = c;
        const ok = matches(m);
        catFilter = prev;
        return ok;
      }).length;

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "catbtn" + (c===catFilter ? " active":"");
      btn.innerHTML = `<span>${c}</span><span class="badge">${count}</span>`;
      btn.onclick = ()=>{
        catFilter = c;
        if(baseFilter==="all" && ["Cafeter√≠a","Refresquer√≠a","Snacks"].includes(c)){
          baseFilter = c;
          catFilter = "Todo";
        }
        renderAll();
      };
      el.appendChild(btn);
    });
  }

  function renderSubtabs(){
    const el = $("#subtabs");
    el.innerHTML = "";
    if(baseFilter!=="Cafeter√≠a") return;

    const tabs = ["all","Caliente","Fr√≠o","Frapp√©"];
    const labels = { all:"Todo", "Caliente":"‚òï Caliente", "Fr√≠o":"üßä Fr√≠o", "Frapp√©":"üåÄ Frapp√©" };

    tabs.forEach(t=>{
      const b = document.createElement("button");
      b.type = "button";
      b.className = "pill" + (subFilter===t ? " active":"");
      b.textContent = labels[t];
      b.onclick = ()=>{ subFilter = t; renderAll(); };
      el.appendChild(b);
    });
  }

  function tagHTML(item){
    const chips = [];
    const baseClass = item.baseCat === "Cafeter√≠a" ? "baseCafe"
                    : item.baseCat === "Refresquer√≠a" ? "baseRef"
                    : item.baseCat === "Snacks" ? "baseSnack"
                    : "";
    chips.push(`<span class="tag ${baseClass}">${item.baseCat}</span>`);

    if(item.baseCat==="Cafeter√≠a" && item.subCat){
      const subClass = item.subCat === "Caliente" ? "hot"
                     : item.subCat === "Fr√≠o" ? "cold"
                     : item.subCat === "Frapp√©" ? "frappe"
                     : "";
      chips.push(`<span class="tag ${subClass}">${item.subCat}</span>`);
    }

    if((item.tags||[]).includes("special")){
      chips.push(`<span class="tag special">Especial</span>`);
    }
    return chips.join("");
  }

  function paletteForItem(item){
    const tags = item?.tags || [];
    const base = item?.baseCat || "";
    const sub  = item?.subCat || "";

    if(sub === "Frapp√©" || tags.includes("frappe")) return { c1:"rgba(160,110,255,.98)", c2:"rgba(124,77,255,.78)" };
    if(sub === "Caliente" || tags.includes("hot"))   return { c1:"rgba(255,120,120,.98)", c2:"rgba(255,80,80,.70)" };
    if(sub === "Fr√≠o" || tags.includes("cold"))      return { c1:"rgba(57,184,255,.98)",  c2:"rgba(124,77,255,.70)" };
    if(base === "Snacks")                           return { c1:"rgba(255,214,140,.98)", c2:"rgba(255,180,80,.65)" };
    if(base === "Refresquer√≠a")                     return { c1:"rgba(44,246,196,.96)",  c2:"rgba(57,184,255,.60)" };
    return { c1:"rgba(57,184,255,.98)", c2:"rgba(124,77,255,.75)" };
  }

  function playCardPortal(cardEl, ev, item){
    if(!cardEl) return;

    let x = 0.5, y = 0.42;
    const cx = (ev && (ev.clientX ?? (ev.touches?.[0]?.clientX)));
    const cy = (ev && (ev.clientY ?? (ev.touches?.[0]?.clientY)));
    if(typeof cx === "number" && typeof cy === "number"){
      const r = cardEl.getBoundingClientRect();
      x = (cx - r.left) / Math.max(1, r.width);
      y = (cy - r.top) / Math.max(1, r.height);
    }
    cardEl.style.setProperty("--rx", (x*100).toFixed(1) + "%");
    cardEl.style.setProperty("--ry", (y*100).toFixed(1) + "%");

    const { c1, c2 } = paletteForItem(item);
    cardEl.style.setProperty("--pc1", c1);
    cardEl.style.setProperty("--pc2", c2);

    cardEl.classList.remove("tap");
    void cardEl.offsetWidth;
    cardEl.classList.add("tap");
    clearTimeout(cardEl._tapT);
    cardEl._tapT = setTimeout(()=> cardEl.classList.remove("tap"), 520);
  }

  function playBtnTap(btn){
    if(!btn) return;
    btn.classList.remove("tapBtn");
    void btn.offsetWidth;
    btn.classList.add("tapBtn");
    clearTimeout(btn._tapB);
    btn._tapB = setTimeout(()=> btn.classList.remove("tapBtn"), 260);
  }

  // ‚úÖ Bobok FX global (solo para ESPECIALES)
  const bobokFX = document.getElementById("bobokFX");
  function playBobokFX(cardEl){
    if(!bobokFX || !cardEl) return;

    const r = cardEl.getBoundingClientRect();
    const x = Math.round(r.right - 66);
    const y = Math.round(r.bottom - 74);

    bobokFX.style.setProperty("--bx", `${x}px`);
    bobokFX.style.setProperty("--by", `${y}px`);

    bobokFX.classList.remove("on");
    void bobokFX.offsetWidth;
    bobokFX.classList.add("on");

    clearTimeout(bobokFX._t);
    bobokFX._t = setTimeout(()=> bobokFX.classList.remove("on"), 650);
  }

  function renderCards(){
    const cards = $("#cards");
    const results = MENU.filter(matches);
    $("#resultHint").textContent = results.length ? `${results.length} opciones` : "Sin resultados";
    $("#sectionName").textContent = baseFilter==="all" ? "Todo" : baseFilter;

    cards.innerHTML = "";
    results.forEach(item=>{
      const div = document.createElement("div");
      div.className = "item";

      div.innerHTML = `
        <div class="tapHalo" aria-hidden="true"></div>
        <div class="tapPortal" aria-hidden="true"></div>
        <div class="tagrow">${tagHTML(item)}</div>
        <p class="name">${item.name}</p>
        <p class="desc">${item.desc || ""}</p>
        <div class="prices">
          ${Object.entries(item.sizes).map(([size, price])=>`
            <button class="pricebtn" type="button" data-id="${item.id}" data-size="${size}">
              <small>${size}</small> ${money(price)}
            </button>
          `).join("")}
        </div>
      `;

      // click en card (no bot√≥n)
      div.addEventListener("click", (ev)=>{
        if(ev.target.closest(".pricebtn")) return;
        playCardPortal(div, ev, item);
        if((item.tags||[]).includes("special")) playBobokFX(div);
      }, { passive:true });

      // click bot√≥n precio: portal + modal (+ bobok si especial)
      div.querySelectorAll(".pricebtn").forEach(b=>{
        b.addEventListener("click", (ev)=>{
          playBtnTap(b);
          playCardPortal(div, ev, item);
          if((item.tags||[]).includes("special")) playBobokFX(div);
          openModal(item.id, b.dataset.size);
        }, { passive:true });
      });

      cards.appendChild(div);
    });
  }

  // ===== Modal portal =====
  const portalFX = document.getElementById("portalFX");
  function openPortalForItem(item){
    const { c1, c2 } = paletteForItem(item);
    document.documentElement.style.setProperty("--portal", c1);
    document.documentElement.style.setProperty("--portal2", c2);

    portalFX.classList.remove("on");
    void portalFX.offsetWidth;
    portalFX.classList.add("on");
  }
  function closePortal(){ portalFX.classList.remove("on"); }

  // ===== Modal + Extras + Opciones =====
  let modalItem = null;

  function extrasOptions(item){
    if(item?.baseCat === "Snacks" || item?.baseCat === "Refresquer√≠a") return ["Sin extras"];
    if(item?.baseCat === "Cafeter√≠a") return ["Sin extras", "Con extra (+10)", "Extra shot (+10)"];
    return ["Sin extras"];
  }

  function getOptions(item){
    if(!item) return ["Normal"];
    if(item.baseCat === "Snacks") return null;

    const base = [];
    if(item.baseCat === "Cafeter√≠a") base.push("Normal", "Descafeinado");
    else if(item.baseCat === "Refresquer√≠a") base.push("Normal", "Poco hielo");
    else base.push("Normal");

    const extra = Array.isArray(item.options) ? item.options : [];
    const merged = [...base, ...extra];
    return merged.filter((v,i,a)=>a.indexOf(v)===i);
  }

  function openModal(itemId, preSize){
    modalItem = MENU.find(x=>x.id===itemId);
    if(!modalItem) return;

    $("#mTitle").textContent = modalItem.name;
    $("#mMeta").textContent = `${modalItem.baseCat}${modalItem.subCat ? " ‚Ä¢ " + modalItem.subCat : ""}`;

    const sizeSel = $("#mSize");
    sizeSel.innerHTML = Object.entries(modalItem.sizes)
      .map(([s,p])=>`<option value="${s}">${s} ‚Äî ${money(p)}</option>`).join("");
    if(preSize) sizeSel.value = preSize;

    const optWrap = $("#optionWrap");
    const optSel = $("#mOption");
    const opts = getOptions(modalItem);

    if(opts === null){
      optWrap.style.display = "none";
      optSel.innerHTML = "";
      optSel.value = "";
    } else {
      optWrap.style.display = "block";
      optSel.innerHTML = opts.map(o=>`<option value="${o}">${o}</option>`).join("");
      optSel.value = opts[0] || "Normal";
    }

    const cafeWrap = $("#flavorWrapCafe");
    const cafeSel = $("#mFlavorCafe");
    if(modalItem.baseCat === "Cafeter√≠a"){
      cafeWrap.style.display = "block";
      cafeSel.innerHTML = FLAVORS_CAFE.map(f=>`<option value="${f}">${f}</option>`).join("");
      cafeSel.value = "Sin sabor";
    } else {
      cafeWrap.style.display = "none";
      cafeSel.innerHTML = "";
    }

    const lemonWrap = $("#flavorWrapLemon");
    const lemonSel = $("#mFlavorLemon");
    const addBtn = $("#mAdd");

    if(modalItem.id === LEMON_FLAVOR_ITEM_ID){
      lemonWrap.style.display = "block";
      lemonSel.innerHTML =
        `<option value="" selected disabled>Selecciona un sabor‚Ä¶</option>` +
        FLAVORS_LEMON.map(f=>`<option value="${f}">${f}</option>`).join("");
      lemonSel.value = "";
      addBtn.disabled = true;
      lemonSel.onchange = ()=>{ addBtn.disabled = !lemonSel.value; };
    } else {
      lemonWrap.style.display = "none";
      lemonSel.innerHTML = "";
      lemonSel.onchange = null;
      addBtn.disabled = false;
    }

    const extSel = $("#mExtras");
    extSel.innerHTML = extrasOptions(modalItem).map(e=>`<option value="${e}">${e}</option>`).join("");

    const noExtras = (modalItem.baseCat==="Snacks" || modalItem.baseCat==="Refresquer√≠a");
    if(noExtras){
      extSel.value = "Sin extras";
      extSel.disabled = true;
      $("#extrasHint").textContent = "Sin extras. Si deseas algo extra, especif√≠calo en notas.";
    } else {
      extSel.disabled = false;
      $("#extrasHint").textContent = "‚ÄúCon extra‚Äù (+$10) ‚Ä¢ ‚ÄúExtra shot‚Äù (+$10)";
    }

    $("#mNotes").value = "";

    $("#modalOverlay").classList.add("open");
    requestAnimationFrame(() => openPortalForItem(modalItem));
  }

  function closeModal(){
    $("#modalOverlay").classList.remove("open");
    closePortal();
  }
  $("#mClose").onclick = closeModal;
  $("#mCancel").onclick = closeModal;
  $("#modalOverlay").addEventListener("click", (e)=>{ if(e.target.id === "modalOverlay") closeModal(); });

  // ===== Carrito =====
  function addToCart(item, size, option, flavorLabel, extras, notes){
    const basePrice = item.sizes[size] ?? 0;
    const extraPrice = Number((extras?.match(/\+(\d+)/)?.[1]) || 0);
    const price = basePrice + extraPrice;

    const safeNotes = String(notes || "").replace(/\s+/g, " ").trim();
    const safeExtras = String(extras || "Sin extras").trim();
    const safeOption = (item.baseCat === "Snacks") ? "" : String(option || "Normal").trim();
    const safeFlavor = String(flavorLabel || "").trim();

    const key = [item.id, size, safeOption, safeFlavor, safeExtras, safeNotes].join("|");

    const existing = cart.find(x=>x.key===key);
    if(existing) existing.qty += 1;
    else cart.push({
      key,
      id:item.id,
      baseCat:item.baseCat,
      name:item.name,
      size,
      option: safeOption,
      flavor: safeFlavor,
      extras: safeExtras,
      notes: safeNotes,
      price,
      qty:1
    });

    renderCart();
  }

  function renderCart(){
    const list = $("#cartlist");
    list.innerHTML = "";

    if(!cart.length){
      list.innerHTML = `<div class="hint" style="padding:10px; border:1px dashed rgba(26,37,80,.8); border-radius:14px; background:rgba(5,7,18,.25)">
        Tu carrito est√° vac√≠o. Toca un precio para agregar.
      </div>`;
      $("#total").textContent = money(0);
      updateFloating();
      return;
    }

    cart.forEach((c)=>{
      const div = document.createElement("div");
      div.className = "lineitem";

      const parts = [];
      parts.push(c.size);

      if(c.baseCat !== "Snacks"){
        const opt = c.option ? c.option : "Normal";
        parts.push(opt);
      }
      if(c.flavor) parts.push(c.flavor);
      if(c.extras && c.extras!=="Sin extras") parts.push(c.extras);
      if(c.notes) parts.push(c.notes);

      div.innerHTML = `
        <div style="min-width:0">
          <p class="li-title">${c.name}</p>
          <div class="li-sub">${parts.join(" ‚Ä¢ ")}</div>
          <div class="li-sub" style="margin-top:6px; opacity:.9"><strong>${money(c.price)}</strong></div>
        </div>
        <div class="li-actions">
          <button class="mini" type="button" data-act="minus" data-key="${c.key}" aria-label="Menos">‚àí</button>
          <div class="qty">${c.qty}</div>
          <button class="mini" type="button" data-act="plus" data-key="${c.key}" aria-label="M√°s">+</button>
          <button class="mini" type="button" data-act="del" data-key="${c.key}" aria-label="Borrar" title="Borrar">üóëÔ∏è</button>
        </div>
      `;
      list.appendChild(div);
    });

    const total = cart.reduce((s,x)=>s + x.price*x.qty, 0);
    $("#total").textContent = money(total);
    updateFloating();
  }

  $("#cartlist").addEventListener("click", (e)=>{
    const btn = e.target.closest("button.mini");
    if(!btn) return;

    const act = btn.dataset.act;
    const key = btn.dataset.key;
    const idx = cart.findIndex(x=>x.key===key);
    if(idx < 0) return;

    if(act === "minus"){
      cart[idx].qty -= 1;
      if(cart[idx].qty <= 0) cart.splice(idx,1);
      renderCart();
    } else if(act === "plus"){
      cart[idx].qty += 1;
      renderCart();
    } else if(act === "del"){
      const label = `${cart[idx].name} (${cart[idx].size})`;
      const ok = confirm(`¬øBorrar este producto del pedido?\n\n${label}`);
      if(!ok) return;
      cart.splice(idx, 1);
      renderCart();
    }
  });

  $("#mAdd").onclick = ()=>{
    if(!modalItem) return;
    const size = $("#mSize").value;

    let option = $("#mOption").value;
    if(modalItem.baseCat === "Snacks") option = "";

    let flavorLabel = "";
    if(modalItem.baseCat === "Cafeter√≠a"){
      const f = $("#mFlavorCafe").value;
      flavorLabel = (f && f !== "Sin sabor") ? f : "";
    }

    if(modalItem.id === LEMON_FLAVOR_ITEM_ID){
      const chosen = $("#mFlavorLemon").value;
      if(!chosen){
        alert("Selecciona un sabor para la limonada üôÇ");
        $("#mFlavorLemon")?.focus();
        return;
      }
      flavorLabel = chosen;
    }

    let extras = $("#mExtras").value;
    if(modalItem.baseCat === "Snacks" || modalItem.baseCat === "Refresquer√≠a"){
      extras = "Sin extras";
    }

    const notes = $("#mNotes").value.trim();
    addToCart(modalItem, size, option, flavorLabel, extras, notes);
    closeModal();
  };

  $("#clearCart").onclick = ()=>{
    if(!cart.length) return;
    const ok = confirm("¬øVaciar el carrito?\n\nEsto borrar√° toda la orden sin enviarla.");
    if(!ok) return;
    cart = [];
    renderCart();
  };

  function setCartTab(tab){
    $("#tabOrder").classList.toggle("active", tab==="order");
    $("#tabName").classList.toggle("active", tab==="name");
    $("#cartView").style.display = (tab==="order") ? "block" : "none";
    $("#nameView").style.display = (tab==="name") ? "block" : "none";
  }
  $("#tabOrder").onclick = ()=>setCartTab("order");
  $("#tabName").onclick = ()=>setCartTab("name");

  const nameInput = document.getElementById("customerName");
  if(nameInput){
    nameInput.value = customerName;
    nameInput.addEventListener("input", ()=>{
      customerName = nameInput.value.trim();
      localStorage.setItem(NAME_KEY, customerName);
    });
  }

  function buildOrderText(){
    const lines = [];
    lines.push("Pedido ‚Äî CAF√â PORTAL");
    if(customerName) lines.push("Nombre: " + customerName);
    lines.push("‚Äî");
    cart.forEach(c=>{
      const parts = [];
      parts.push(`${c.qty}√ó ${c.name} (${c.size})`);
      if(c.baseCat !== "Snacks"){
        const opt = c.option ? c.option : "Normal";
        parts.push(opt);
      }
      if(c.flavor) parts.push(c.flavor);
      if(c.extras && c.extras!=="Sin extras") parts.push(c.extras);
      if(c.notes) parts.push(c.notes);
      lines.push(`${parts.join(" ‚Ä¢ ")} = ${money(c.price*c.qty)}`);
    });
    const total = cart.reduce((s,x)=>s + x.price*x.qty, 0);
    lines.push("‚Äî");
    lines.push("Total: " + money(total));
    return lines.join("\n");
  }

  function sendToWhatsApp(){
    if(!cart.length){
      alert("Tu carrito est√° vac√≠o üôÇ");
      return;
    }

    if(!customerName){
      const go = confirm("Antes de enviar, escribe tu nombre.\n\n¬øQuieres agregar tu nombre ahora?");
      if(go){
        setCartTab("name");
        document.getElementById("cartPanel")?.scrollIntoView({ behavior:"smooth", block:"start" });
        setTimeout(()=> document.getElementById("customerName")?.focus(), 250);
      }
      return;
    }

    const items = cart.reduce((s,x)=>s + x.qty, 0);
    const total = cart.reduce((s,x)=>s + x.price*x.qty, 0);

    const ok = confirm(`¬øEnviar pedido por WhatsApp?\n\nNombre: ${customerName}\nItems: ${items}\nTotal: ${money(total)}`);
    if(!ok) return;

    const text = buildOrderText();
    const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
    window.open(url, "_blank");

    cart = [];
    renderCart();
  }
  $("#checkout").onclick = sendToWhatsApp;

  $("#waFloat").onclick = ()=>{
    const cartEl = document.getElementById("cartPanel");
    if(!cartEl) return;
    cartEl.scrollIntoView({ behavior: "smooth", block: "start" });
    cartEl.animate(
      [
        { boxShadow: "0 0 0 rgba(0,0,0,0)" },
        { boxShadow: "0 0 0 2px rgba(57,184,255,.7), 0 0 36px rgba(57,184,255,.35)" },
        { boxShadow: "0 0 0 rgba(0,0,0,0)" }
      ],
      { duration: 700, easing: "ease-out" }
    );
  };

  function updateFloating(){
    const items = cart.reduce((s,x)=>s + x.qty, 0);
    const total = cart.reduce((s,x)=>s + x.price*x.qty, 0);
    $("#waBadge").textContent = `${items} item${items===1?"":"s"} ‚Ä¢ ${money(total)}`;

    const btn = $("#waFloat");
    if(items > 0){
      btn.style.opacity = "1";
      btn.style.pointerEvents = "auto";
      btn.style.transform = "translateX(-50%) translateY(0)";
    } else {
      btn.style.opacity = "0";
      btn.style.pointerEvents = "none";
      btn.style.transform = "translateX(-50%) translateY(10px)";
    }
  }

  function setBase(v){
    baseFilter = v;
    catFilter = "Todo";
    subFilter = "all";
    renderAll();
  }
  $("#baseAll").onclick = ()=>setBase("all");
  $("#baseCafe").onclick = ()=>setBase("Cafeter√≠a");
  $("#baseRef").onclick = ()=>setBase("Refresquer√≠a");
  $("#baseSnk").onclick = ()=>setBase("Snacks");

  $("#q").addEventListener("input", (e)=>{ query = e.target.value; renderAll(); });

  function renderAll(){
    updateHeroTitle();
    renderBasePills();
    renderSubtabs();
    renderLeftCats();
    renderCards();
    renderCart();
  }

  (function starfield(){
    const canvas = document.getElementById("stars");
    const ctx = canvas.getContext("2d", { alpha:true });

    let w=0,h=0, dpr=1;
    let stars = [];
    const STAR_COUNT = 220;

    function resize(){
      dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      w = window.innerWidth;
      h = window.innerHeight;
      canvas.width = Math.floor(w*dpr);
      canvas.height = Math.floor(h*dpr);
      canvas.style.width = w + "px";
      canvas.style.height = h + "px";
      ctx.setTransform(dpr,0,0,dpr,0,0);

      stars = Array.from({length: STAR_COUNT}, ()=>({
        x: Math.random()*w,
        y: Math.random()*h,
        r: Math.random()*1.3 + 0.2,
        a: Math.random()*0.65 + 0.15,
        s: Math.random()*0.20 + 0.03,
        tw: Math.random()*0.018 + 0.004,
        ph: Math.random()*Math.PI*2
      }));
    }

    function draw(t){
      ctx.clearRect(0,0,w,h);
      const g = ctx.createRadialGradient(w*0.5,h*0.35, 0, w*0.5,h*0.35, Math.max(w,h)*0.7);
      g.addColorStop(0, "rgba(57,184,255,0.06)");
      g.addColorStop(0.55, "rgba(124,77,255,0.04)");
      g.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = g;
      ctx.fillRect(0,0,w,h);

      const time = t * 0.001;
      for(const s of stars){
        s.y += s.s;
        if(s.y > h+10){ s.y = -10; s.x = Math.random()*w; }
        const twinkle = 0.55 + 0.45*Math.sin(time*6*s.tw + s.ph);
        const a = s.a * twinkle;

        ctx.beginPath();
        ctx.fillStyle = `rgba(234,240,255,${a})`;
        ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        ctx.fill();
      }
      requestAnimationFrame(draw);
    }

    window.addEventListener("resize", resize, { passive:true });
    resize();
    requestAnimationFrame(draw);
  })();

  // init
  setCartTab("order");
  updateFloating();
  renderAll();
</script>
</body>
</html>